<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="shortcut icon" href="\assets\images\favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <script src="/javascript/main.js"></script>   
    <style>
        main {
            text-align: center;
        }
    </style>           
</head>
<body>
    <header>
        <nav class="nav-bar">
            <ul class="nav-list">
                <a id="home-button" href="/html/index.html">
                    <li>
                        Home
                    </li>
                </a>
                <a id="portfolio-button" href="/html/portfolio.html">
                    <li>
                        Portfolio
                    </li>
                </a>
                <a id="aboutMe-button" href="/html/about-me.html">
                    <li>
                        About Me
                    </li>
                </a>
                <a id="contact-button" href="/html/contact.html">
                    <li>
                        Contact
                    </li>
                </a>    
            </ul>
        </nav>
    </header>

    <main>
        <hgroup>
            <h1>Cesar's Notable Classes at UCSD</h1>
            <p>Here are a list of classes that I have taken at UCSD, including the ones important for
                my programming career as well as others that have sparked my interest.
            </p>
        </hgroup>

        <div id="load-buttons">
            <button id="load-local">Load Local</button>
            <button id="load-remote">Load Remote</button>
            <button id="create-card">Create Card</button>
        </div>
        <card-info>
            <img src="\assets\images\info-icon.png" alt="Information Icon">
            <p>Edit only works on locally loaded components. To edit a card, click on class title or image.</p>
        </card-info>

        <div id="catalog">
        </div>

        <script type="module" src="/javascript/class-component.js"></script>
        <script>
            records = {};
            window.addEventListener('DOMContentLoaded', async () => {
                localStorage.setItem('catalog', await fetch('/json/sampledata.json').then(response => response.text()) );
                records = JSON.parse(localStorage.getItem('catalog'));
            });

            const createCardButton = document.getElementById('create-card');
            const loadLocalButton = document.getElementById('load-local');
            const loadRemoteButton = document.getElementById('load-remote');
            const catalog = document.getElementById('catalog');

            // Updates to class cards on click
            catalog.addEventListener('click', (event) => {
                let target = event.target.closest('class-card');
                records = JSON.parse(localStorage.getItem('catalog'));
                if (target) {
                    if (event.target.tagName === 'H2') {
                        const hgroupTag = target.querySelector('hgroup');
                        const field = target.querySelector('.field');
                        const name = target.querySelector('h2');
                        const link = target.querySelector('a');
                        const topic = field.innerHTML.split(' ')[0];
                        const code = field.innerHTML.split(' ')[1];

                        if (target.querySelector('form')) return;

                        hgroupTag.outerHTML = `
                            <form class="edit-deets-form">
                                <label for='topic'>Class Topic:</label>
                                <textarea name='topic' rows='2' required>${topic}</textarea> <br>
                                <label for='code'>Class Code:</label>
                                <textarea name='code' rows='2' required>${code}</textarea> <br>
                                <label for='name'>Class Name:</label>
                                <textarea name='name' rows='2' required>${name.textContent}</textarea> <br>
                                <label for='link'>Course Info URL:</label>
                                <textarea name='link' rows='2' required>${link.href}</textarea> <br>
                                <button type="submit">Save</button>
                            </form>
                        `;

                        // Input validation to prevent whitespace characters in topic and code fields
                        target.querySelector('textarea[name="topic"]').addEventListener('keydown', function(event) {
                            // Prevent spacebar, tab, and enter key presses
                            if (event.key === ' ' || event.key === 'Tab' || event.key === 'Enter') {
                            event.preventDefault();
                            }
                        });
                        target.querySelector('textarea[name="topic"]').addEventListener('input', function() {
                            // Remove any pasted or existing whitespace characters
                            this.value = this.value.replace(/\s/g, '');
                        });
                        target.querySelector('textarea[name="code"]').addEventListener('keydown', function(event) {
                            // Prevent spacebar, tab, and enter key presses
                            if (event.key === ' ' || event.key === 'Tab' || event.key === 'Enter') {
                            event.preventDefault();
                            }
                        });
                        target.querySelector('textarea[name="code"]').addEventListener('input', function() {
                            // Remove any pasted or existing whitespace characters
                            this.value = this.value.replace(/\s/g, '');
                        });

                        const form = target.querySelector('.edit-deets-form');
                        form.addEventListener('submit', async (e) => {

                            // don't redirect to whatever the form would normally redirect to.
                            e.preventDefault();

                            const newTopic = form.querySelector('textarea[name="topic"]').value;
                            const newCode = form.querySelector('textarea[name="code"]').value;
                            const newName = form.querySelector('textarea[name="name"]').value;
                            const newLink = form.querySelector('textarea[name="link"]').value;
                            const oldKey = topic+code;
                            const newKey = newTopic+newCode;
                            records[oldKey]['field'] = newTopic;
                            records[oldKey]['code'] = newCode;
                            records[oldKey]['name'] = newName;
                            records[oldKey]['link'] = newLink;
                            form.outerHTML = `
                                <hgroup>
                                    <p class="field">${newTopic} ${newCode}</p>
                                    <h2>${newName}</h2>
                                    <a href="${newLink}">Course Info</a>
                                </hgroup>`;
                            if (oldKey !== newKey) {   
                                records[newKey] = records[oldKey];
                                delete records[oldKey];
                            }
                            localStorage.setItem("catalog", JSON.stringify(records));
                        });
                    } else if (event.target.tagName === 'IMG') {
                        const pictureTag = target.querySelector('picture');
                        const img = target.querySelector('img');
                        const note = target.querySelector('.class-note');

                        if (target.querySelector('form')) return;

                        pictureTag.innerHTML = ``;
                        note.outerHTML = `
                            <form class="edit-deets-form">
                                <label for='image'>Image URL:</label>
                                <textarea name='image' rows='5' required>${img.src}</textarea> <br>
                                <label for='alternateText'>Image Alternate Text:</label>
                                <textarea name='alternateText' rows='2' required>${img.alt}</textarea> <br>
                                <label for='note'>Note:</label>
                                <textarea name='note' rows='5' required>${note.textContent}</textarea> <br>
                                <button type="submit">Save</button>
                            </form>
                        `;
                        const form = target.querySelector('.edit-deets-form');
                        form.addEventListener('submit', async (e) => {

                            // don't redirect to whatever the form would normally redirect to.
                            e.preventDefault();

                            const newImg = form.querySelector('textarea[name="image"]').value;
                            const newAlt = form.querySelector('textarea[name="alternateText"]').value;
                            const newDeets = form.querySelector('textarea[name="note"]').value;
                            const myKey = target.querySelector('.field').innerText.split(' ').join('');
                            records[myKey]['image'] = newImg;
                            records[myKey]['alt'] = newAlt;
                            records[myKey]['note'] = newDeets;
                            localStorage.setItem("catalog", JSON.stringify(records));
                            form.outerHTML = `<p class="class-note">${newDeets}</p>`;
                            pictureTag.innerHTML = `<img src="${newImg}" alt="${newAlt}">`;
                        });
                    } 
                }
            });

            createCardButton.addEventListener('click', () => {
                records = JSON.parse(localStorage.getItem('catalog'));
                if (records['NewClass000']) {
                    alert("You have already created a new class card. Please edit the existing one before creating another.");
                    return;
                }

                const classCard = document.createElement('class-card');
                
                classCard.setAttribute("code", "000");
                classCard.setAttribute("field", "NewClass");
                classCard.setAttribute("name", "New Class Name");
                classCard.setAttribute("image", "https://pub-b218e43006be4ff0a0f3097f9dc642f9.r2.dev/images/placeholder-image.png");
                classCard.setAttribute("note", "This is a newly created class card. Click on the title or image to edit.");
                classCard.setAttribute("link", "https://example.com");
                catalog.appendChild(classCard);
                const myKey = "NewClass000";
                const data = JSON.parse(localStorage.getItem('catalog'));
                data[myKey] = {
                    code: "000",
                    field: "NewClass",
                    name: "New Class Name",
                    image: "https://pub-b218e43006be4ff0a0f3097f9dc642f9.r2.dev/images/placeholder-image.png",
                    alt: "Placeholder Image",
                    note: "This is a newly created class card. Click on the title or image to edit.",
                    link: "https://example.com"
                };
                localStorage.setItem('catalog', JSON.stringify(data));
            });

            loadLocalButton.addEventListener('click', () => {
                catalog.innerHTML = ''; 
                loadLocalData();
            });

            loadRemoteButton.addEventListener('click', () => {
                catalog.innerHTML = ''; 
                loadRemoteData();
            });

            function loadLocalData() {
                const data = JSON.parse(localStorage.getItem('catalog'));
                for (const key in data) {
                    const classInfo = data[key];
                    const classCard = document.createElement('class-card');
                    
                    classCard.setAttribute("code", classInfo.code);
                    classCard.setAttribute("field", classInfo.field);
                    classCard.setAttribute("name", classInfo.name);
                    classCard.setAttribute("image", classInfo.image);
                    classCard.setAttribute("note", classInfo.note);
                    classCard.setAttribute("link", classInfo.link);
                    catalog.appendChild(classCard);
                }
            }

            async function loadRemoteData() {
                const url = "https://api.jsonbin.io/v3/b/69322020d0ea881f40137d1e";
                let records = {}

                
                // Attempt to get data from remote resource (I am use fetch in this case)
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }

                const jsonData = await response.json();
                // if you use my json server make sure the .record part is removed
                records = jsonData.record;

                for (const key in records) {
                    const classInfo = records[key];
                    const classCard = document.createElement('class-card');
                    
                    classCard.setAttribute("code", classInfo.code);
                    classCard.setAttribute("field", classInfo.field);
                    classCard.setAttribute("name", classInfo.name);
                    classCard.setAttribute("image", classInfo.image);
                    classCard.setAttribute("note", classInfo.note);
                    classCard.setAttribute("link", classInfo.link);
                    catalog.appendChild(classCard);
                }
            }
        </script>

    </main>

    <footer>
        <button id="theme-toggle">ðŸŒ™ Dark Mode</button> 
        <noscript>This button doesn't work without Javascript.</noscript>
    </footer>

    <noscript>
        <p>You have Javascript disabled or are using a browser that does not support Javascript.</p>
    </noscript>
</body>
</html>